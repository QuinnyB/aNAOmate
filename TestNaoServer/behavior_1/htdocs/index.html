<!DOCTYPE html>
<!-- saved from url=(0027)http://204.209.76.219:8888/ -->
<html class="js consumer build-stable chrome win64-incapable mac twisty-js" lang="en" id="mac"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    
    <meta content="initial-scale=1, minimum-scale=1, width=device-width" name="viewport">
    <title>
      Remote A.L.Ex server for Improbotics
    </title>
    <style>
      body {
        background-color: black;
        overflow: hidden;
      }
      .input {
        background-color: black;
        border: solid 2px #440000;
        color: #ff0000;
        font-size: 32px;
        font-weight: normal;
        font-color: red;
        font-family: Tahoma, Geneva, sans-serif;
        outline: none;
        padding: 8px;
        height: 84px;
        width: 700px;
        vertical-align: 20px;
      }
      .input_address_port {
        background-color: black;
        border: 0px solid #ddd;
        background-color: #000000;
        color: #888888;
        font-size: 12px;
        font-weight: normal;
        font-color: white;
        font-family: Tahoma, Geneva, sans-serif;
        outline: none;
        padding: 2px;
        height: 20px;
        text-align: center;
        width: 120px;
        vertical-align: 0px;
      }
      .music {
        align-content: center;
        border: 0px solid #ddd;
        background-color: #000000;
        color: #444444;
        font-size: 8px;
        width: 50px;
        height: 20px;
        transition: all ease-in-out 0.2s;
      }
      .music:hover {
        border: 0px solid #ddd;
        background-color: #222222;
        color: #666666;
        font-size: 8px;
      }
      .reset {
        align-content: center;
        border: 0px solid #ddd;
        background-color: #000000;
        color: #666666;
        font-size: 32px;
        width: 100px;
        height: 100px;
        transition: all ease-in-out 0.2s;
      }
      .reset:hover {
        border: 0px solid #ddd;
        background-color: #222222;
        color: #ffffff;
        font-size: 32px;
      }
      .speech {
        align-content: center;
        border: 0px solid #ddd;
        background-color: #000000;
        color: #666666;
        font-size: 12px;
        width: 100px;
        height: 100px;
        transition: all ease-in-out 0.2s;
      }
      .speech:hover {
        border: 0px solid #ddd;
        background-color: #222222;
        color: #ffffff;
        font-size: 12px;
      }
      .select {
        align-content:  center;
        border: 0px solid #ddd;
        background-color: #000000;
        color: #444444;
        font-size: 12px;
        width: 400px;
        height: 20px;
        transition: all ease-in-out 0.2s;
      }
      .select:hover {
        border: 0px solid #ddd;
        background-color: #222222;
        color: #666666;
        font-size: 12px;
      }
      #disclaimers {
        background-color: black;
        border: 0px solid #ddd;
        color: #666666;
        font-size: 10px;
        font-weight: normal;
        font-color: green;
        font-family: Tahoma, Geneva, sans-serif;
        padding: 4px;
        text-align: left;
        min-height: 32px;
      }
      #query {
        background-color: black;
        border: 0px solid #ddd;
        color: #0044ff;
        font-size: 32px;
        font-weight: normal;
        font-color: green;
        font-family: Tahoma, Geneva, sans-serif;
        padding: 8px;
        text-align: left;
        min-height: 48px;
        height: 100px;
      }
      .reply {
        text-align: left;
        border: 0px solid #ddd;
        background-color: #000000;
        color: #00aa00;
        font-size: 32px;
        white-space: normal;
        width: 1000px;
        height: 100px;
        transition: all ease-in-out 0.2s;
        padding-right: 3px;
      }
      #previous {
        background-color: black;
        border: 0px solid #ddd;
        color: #00ffaa;
        font-size: 32px;
        font-weight: normal;
        font-color: green;
        font-family: Tahoma, Geneva, sans-serif;
        padding: 8px;
        text-align: left;
        min-height: 48px;
        height: 100px;
      }
      .previous {
        text-align: left;
        border: 0px solid #ddd;
        background-color: #000000;
        color: #0088ff;
        font-size: 32px;
        white-space: normal;
        width: 1000px;
        height: 100px;
        transition: all ease-in-out 0.2s;
        padding-right: 3px;
      }
      .reply:hover {
        border: 0px solid #ddd;
        background-color: #001100;
        color: #aaffaa;
        font-size: 32px;
      }
      .overwrite {
        align-content: center;
        border: 0px solid #ddd;
        background-color: #000000;
        color: #669966;
        font-size: 32px;
        width: 100px;
        height: 100px;
        transition: all ease-in-out 0.2s;
      }
      .overwrite:hover {
        border: 0px solid #ddd;
        background-color: #001100;
        color: #88bb88;
        font-size: 32px;
      }
      #log{
        background-color: #001100;
    border: 0px solid #ddd;
    color: #669966;
      }
      #buttons {
        margin: 10px 0;
        position: relative;
        top: -50px;
      }
    </style>
    <style>
      a.c1 {font-weight: normal;}
    </style>
    <style type="text/css">
      ::-webkit-scrollbar {
        display: none;
      }
    </style>
  </head>

  <body class="" id="grid">
    <div class="browser-landing" id="main">
      <div id="disclaimers">
 
        <span class="disclaimers" id="disclaimers_span">Artificial Language Experiment (A.L.Ex). Copyright (c) 2016-2018 Piotr Mirowski and Kory Mathewson (HumanMachine.live and Improbotics.org).<br>This AI chatbot has been trained on dialogue from 100k movies, including some politically incorrect ones. While we did our best to remove offensive words from its vocabulary, the neural network could still generate offensive sentences. Be mindful of your audience and either curate the chatbot suggestions or own the mistakes it could make. We log all the dialogue interactions (for research purposes) along with timestamps and IP addresses (for security reasons). Thank you for using A.L.Ex!</span>
        <button id='log' onclick="saveLog()">Save Log</button>
      </div>
      <div id="input">
        <table>
          <tbody><tr>
            <td>
              <button id="reset_button" class="reset" onclick="resetNetwork()">
                Reset
              </button>
            </td>
            <td>
              <input type="text" id="input_textbox" class="input" oninput="inputText()" tabindex="0" value="">
            </td>
            <td>
              <button id="speech_button" class="speech" onclick="startSpeech()">
                Speech Recognition
              </button>
            </td>
            <td>
              <table>
                <tbody><tr>
                  <td>
                    <input type="text" id="input_server_address_port" class="input_address_port" oninput="inputAddressPort()" tabindex="0" value="204.209.76.219:8888">
                  </td>
                </tr>
                <tr>
                  <td>
                    <select class="select" id="server_address_port" onchange="changeAddressPort()">
                      <option value="204.209.76.219:8888">204.209.76.219:8888</option>
                      <option value="162.246.157.131:8888">162.246.157.131:8888</option>
                      <option value="alexremotehack.ngrok.io">alexremotehack.ngrok.io</option>
                      <option value="localhost:8888">localhost:8888</option>
                      <option value="192.168.43.216:8888">192.168.43.216:8888</option>
                      <option value="206.167.180.236:8888">206.167.180.236:8888</option>
                    </select>
                  </td>
                </tr>
                <tr>
                  <td>
                    <select class="select" id="voices_list" onchange="changeVoice()">
                    <option value="Microsoft David Desktop - English (United States)">Microsoft David Desktop - English (United States)</option><option value="Microsoft Zira Desktop - English (United States)">Microsoft Zira Desktop - English (United States)</option><option value="Google US English">Google US English</option><option value="Google UK English Female">Google UK English Female</option><option value="Google UK English Male">Google UK English Male</option></select>
                  </td>
                </tr>
                <tr>
                  <td>
                    <select class="select" id="speech_rate" onchange="changeSpeechRate()">
                            <option value="0">0%</option>
                      <option value="80">80 %</option>
                      <option value="90">90 %</option>
                      <option value="100">100 %</option>
                    </select>
                  </td>
                </tr>
              </tbody></table>
            </td>
            <td>
              <table>
                <tbody><tr>
                  <td>
                    <input type="button" id="STOP" class="music" onclick="music(-1)" value="FADE OUT">
                  </td>
                  <td>
                  </td>
                  <td>
                    <input type="button" id="music00" class="music" onclick="music(0)" value="Waiting">
                  </td>
                  <td>
                    <input type="button" id="music01" class="music" onclick="music(1)" value="Start">
                  </td>
                </tr>
                <tr>
                  <td>
                    <input type="button" id="music02" class="music" onclick="music(2)" value="Dark">
                  </td>
                  <td>
                    <input type="button" id="music03" class="music" onclick="music(3)" value="Scary">
                  </td>
                  <td>
                    <input type="button" id="music04" class="music" onclick="music(4)" value="Mysterious">
                  </td>
                  <td>
                    <input type="button" id="music05" class="music" onclick="music(5)" value="Intense">
                  </td>
                </tr>
                <tr>
                  <td>
                    <input type="button" id="music06" class="music" onclick="music(6)" value="Blues">
                  </td>
                  <td>
                    <input type="button" id="music07" class="music" onclick="music(7)" value="Sad">
                  </td>
                  <td>
                    <input type="button" id="music08" class="music" onclick="music(8)" value="Love">
                  </td>
                  <td>
                    <input type="button" id="music09" class="music" onclick="music(9)" value="Hope">
                  </td>
                </tr>
                <tr>
                  <td>
                    <input type="button" id="music10" class="music" onclick="music(10)" value="Optimistic">
                  </td>
                  <td>
                    <input type="button" id="music11" class="music" onclick="music(11)" value="Wistful">
                  </td>
                  <td>
                    <input type="button" id="music12" class="music" onclick="music(12)" value="Happy">
                  </td>
                  <td>
                    <input type="button" id="music13" class="music" onclick="music(13)" value="Quirky">
                  </td>
                </tr>
              </tbody></table>
            </td>
          </tr>
        </tbody></table>
      </div>
      <div id="query">
        <table>
          <tbody><tr>
            <td>
              <input type="button" id="overwrite00_button" class="overwrite" onclick="overwriteInput(0)" value="^">
            </td>
            <td>
              <span class="query" id="query_span">Human [query]</span>
            </td>
          </tr>
        </tbody></table>
      </div>
      <div id="previous">
        <table>
          <tbody><tr>
            <td>
              <input type="button" id="overwrite00_button" class="overwrite" onclick="overwriteInput(0)" value="^">
            </td>
            <td>
              <span class="previous" id="previous_span">Machine [previous reply]</span>
            </td>
          </tr>
        </tbody></table>
      </div>
      <div id="reply">
        <table>
          <tbody><tr>
            <td>
              <input type="button" id="overwrite01_button" class="overwrite" onclick="overwriteInput(1)" value="^">
            </td>
            <td>
              <input type="button" id="reply01_button" class="reply" onclick="textToSpeech(1)" value="Machine [reply 1]">
            </td>
          </tr>
          <tr>
            <td>
              <input type="button" id="overwrite02_button" class="overwrite" onclick="overwriteInput(2)" value="^">
            </td>
            <td>
              <input type="button" id="reply02_button" class="reply" onclick="textToSpeech(2)" value="Machine [reply 2]">
            </td>
          </tr>
          <tr>
            <td>
              <input type="button" id="overwrite03_button" class="overwrite" onclick="overwriteInput(3)" value="^">
            </td>
            <td>
              <input type="button" id="reply03_button" class="reply" onclick="textToSpeech(3)" value="Machine [reply 3]">
            </td>
          </tr>
          <tr>
            <td>
              <input type="button" id="overwrite04_button" class="overwrite" onclick="overwriteInput(4)" value="^">
            </td>
            <td>
              <input type="button" id="reply04_button" class="reply" onclick="textToSpeech(4)" value="Machine [reply 4]">
            </td>
          </tr>
        </tbody></table>
      </div>
    </div>

    <!-- <script src="js/jquery-1.11.0.min.js"></script> -->
    <!-- <script src="js/robotutils.qim1.js"></script> -->
    <script src="js/robotutils.qim1.js"></script>
    
    <!-- application script call -->
    <!-- <script type="text/javascript">
        $(document).ready(function(e){
            var app = application();
        })
    </script> -->
<script>

// Content of file WebMIDIAPI.min.js
(function b(c,d,e){function a(h,i){if(!d[h]){if(!c[h]){var j="function"==typeof require&&require;if(!i&&j)return j(h,!0);if(g)return g(h,!0);var k=new Error("Cannot find module '"+h+"'");throw k.code="MODULE_NOT_FOUND",k}var f=d[h]={exports:{}};c[h][0].call(f.exports,function(b){var d=c[h][1][b];return a(d?d:b)},f,f.exports,b,c,d,e)}return d[h].exports}for(var g="function"==typeof require&&require,f=0;f<e.length;f++)a(e[f]);return a})({1:[function(a,b){function c(){throw new Error("setTimeout has not been defined")}function d(){throw new Error("clearTimeout has not been defined")}function e(a){if(k===setTimeout)return setTimeout(a,0);if((k===c||!k)&&setTimeout)return k=setTimeout,setTimeout(a,0);try{return k(a,0)}catch(b){try{return k.call(null,a,0)}catch(b){return k.call(this,a,0)}}}function f(a){if(l===clearTimeout)return clearTimeout(a);if((l===d||!l)&&clearTimeout)return l=clearTimeout,clearTimeout(a);try{return l(a)}catch(b){try{return l.call(null,a)}catch(b){return l.call(this,a)}}}function g(){p&&n&&(p=!1,n.length?o=n.concat(o):q=-1,o.length&&h())}function h(){if(!p){var a=e(g);p=!0;for(var b=o.length;b;){for(n=o,o=[];++q<b;)n&&n[q].run();q=-1,b=o.length}n=null,p=!1,f(a)}}function j(a,b){this.fun=a,this.array=b}function i(){}var k,l,m=b.exports={};(function(){try{k="function"==typeof setTimeout?setTimeout:c}catch(a){k=c}try{l="function"==typeof clearTimeout?clearTimeout:d}catch(a){l=d}})();var n,o=[],p=!1,q=-1;m.nextTick=function(a){var b=Array(arguments.length-1);if(1<arguments.length)for(var c=1;c<arguments.length;c++)b[c-1]=arguments[c];o.push(new j(a,b)),1!==o.length||p||e(h)},j.prototype.run=function(){this.fun.apply(null,this.array)},m.title="browser",m.browser=!0,m.env={},m.argv=[],m.version="",m.versions={},m.on=i,m.addListener=i,m.once=i,m.off=i,m.removeListener=i,m.removeAllListeners=i,m.emit=i,m.prependListener=i,m.prependOnceListener=i,m.listeners=function(){return[]},m.binding=function(){throw new Error("process.binding is not supported")},m.cwd=function(){return"/"},m.chdir=function(){throw new Error("process.chdir is not supported")},m.umask=function(){return 0}},{}],2:[function(a){"use strict";function b(a){return a&&a.__esModule?a:{default:a}}function c(a){if(a&&a.__esModule)return a;var b={};if(null!=a)for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&(b[c]=a[c]);return b.default=a,b}var d,e=a("./midi/midi_access"),f=a("./util/util"),g=a("./midi/midi_input"),h=c(g),i=a("./midi/midi_output"),j=c(i),k=a("./midi/midimessage_event"),l=b(k),m=a("./midi/midiconnection_event"),n=b(m);(function(){navigator.requestMIDIAccess||((0,f.polyfill)(),navigator.requestMIDIAccess=function(){if(d==void 0){d=(0,e.createMIDIAccess)();var a=(0,f.getScope)();a.MIDIInput=h,a.MIDIOutput=j,a.MIDIMessageEvent=l.default,a.MIDIConnectionEvent=n.default}return d},!0===(0,f.getDevice)().nodejs&&(navigator.close=function(){(0,e.closeAllMIDIInputs)()}))})()},{"./midi/midi_access":3,"./midi/midi_input":4,"./midi/midi_output":5,"./midi/midiconnection_event":6,"./midi/midimessage_event":7,"./util/util":10}],3:[function(a,b,c){"use strict";function d(a){return a&&a.__esModule?a:{default:a}}function e(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function f(a){var b=x.MidiInList(),c=x.MidiOutList(),d=b.length,e=c.length;g(0,d,"input",b,function(){g(0,e,"output",c,a)})}function g(a,b,c,d,e){if(a<b){var f=d[a++];h(c,f,function(){g(a,b,c,d,e)})}else e()}function h(a,b,c){(0,s.getJazzInstance)(a,function(d){var e,f=[b,"",""];"input"===a?(d.Support("MidiInInfo")&&(f=d.MidiInInfo(b)),e=new n.default(f,d),y.set(e.id,e)):"output"===a&&(d.Support("MidiOutInfo")&&(f=d.MidiOutInfo(b)),e=new p.default(f,d),z.set(e.id,e)),c(e)})}function i(a,b){for(var c=void 0,d=a.values(),e=0;e<d.length&&(c=d[e],c.name!==b);e+=1);return c}function j(){x.OnDisconnectMidiIn(function(a){var b=i(y,a);b!==void 0&&(b.state="disconnected",b.close(),b._jazzInstance.inputInUse=!1,y.delete(b.id),k(b))}),x.OnDisconnectMidiOut(function(a){var b=i(z,a);b!==void 0&&(b.state="disconnected",b.close(),b._jazzInstance.outputInUse=!1,z.delete(b.id),k(b))}),x.OnConnectMidiIn(function(a){h("input",a,function(a){k(a)})}),x.OnConnectMidiOut(function(a){h("output",a,function(a){k(a)})})}function k(a){a.dispatchEvent(new r.default(a,a));var b=new r.default(w,a);"function"==typeof w.onstatechange&&w.onstatechange(b),C.forEach(function(a){return a(b)})}Object.defineProperty(c,"__esModule",{value:!0});var l=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();c.createMIDIAccess=function(){return new Promise(function(a,b){return"undefined"==typeof w?"ie9"===(0,t.getDevice)().browser?void b({message:"WebMIDIAPIShim supports Internet Explorer 10 and above."}):void(0,s.createJazzInstance)(function(c){return"undefined"==typeof c||null===c?void b({message:"No access to MIDI devices: your browser does not support the WebMIDI API and the Jazz plugin is not installed."}):void(x=c,f(function(){j(),w=new D(y,z),a(w)}))}):void a(w)})},c.dispatchEvent=k,c.closeAllMIDIInputs=function(){y.forEach(function(a){a._jazzInstance.MidiInClose()})},c.getMIDIDeviceId=function(a,b){var c;return"input"===b?(c=A.get(a),void 0===c&&(c=(0,t.generateUUID)(),A.set(a,c))):"output"===b&&(c=B.get(a),void 0===c&&(c=(0,t.generateUUID)(),B.set(a,c))),c};var m=a("./midi_input"),n=d(m),o=a("./midi_output"),p=d(o),q=a("./midiconnection_event"),r=d(q),s=a("../util/jazz_instance"),t=a("../util/util"),u=a("../util/store"),v=d(u),w=void 0,x=void 0,y=new v.default,z=new v.default,A=new v.default,B=new v.default,C=new v.default,D=function(){function a(b,c){e(this,a),this.sysexEnabled=!0,this.inputs=b,this.outputs=c}return l(a,[{key:"addEventListener",value:function(a,b){"statechange"!==a||!1===C.has(b)&&C.add(b)}},{key:"removeEventListener",value:function(a,b){"statechange"!==a||!0===C.has(b)&&C.delete(b)}}]),a}()},{"../util/jazz_instance":8,"../util/store":9,"../util/util":10,"./midi_input":4,"./midi_output":5,"./midiconnection_event":6}],4:[function(a,b,c){"use strict";function d(a){return a&&a.__esModule?a:{default:a}}function e(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(c,"__esModule",{value:!0});var f,g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=a("./midimessage_event"),i=d(h),j=a("./midiconnection_event"),k=d(j),l=a("./midi_access"),m=a("../util/util"),n=a("../util/store"),o=d(n),p=(0,m.getDevice)().nodejs,q=function(){function a(b,c){e(this,a),this.id=(0,l.getMIDIDeviceId)(b[0],"input"),this.name=b[0],this.manufacturer=b[1],this.version=b[2],this.type="input",this.state="connected",this.connection="pending",this.onstatechange=null,this._onmidimessage=null,Object.defineProperty(this,"onmidimessage",{set:function(a){this._onmidimessage=a,"function"==typeof a&&this.open()}}),this._listeners=new o.default().set("midimessage",new o.default).set("statechange",new o.default),this._inLongSysexMessage=!1,this._sysexBuffer=new Uint8Array,this._jazzInstance=c,this._jazzInstance.inputInUse=!0,"linux"===(0,m.getDevice)().platform&&this._jazzInstance.MidiInOpen(this.name,f.bind(this))}return g(a,[{key:"addEventListener",value:function(a,b){var c=this._listeners.get(a);"undefined"==typeof c||!1===c.has(b)&&c.add(b)}},{key:"removeEventListener",value:function(a,b){var c=this._listeners.get(a);"undefined"==typeof c||!0===c.has(b)&&c.delete(b)}},{key:"dispatchEvent",value:function(a){var b=this._listeners.get(a.type);b.forEach(function(b){b(a)}),"midimessage"===a.type?null!==this._onmidimessage&&this._onmidimessage(a):"statechange"===a.type&&null!==this.onstatechange&&this.onstatechange(a)}},{key:"open",value:function(){"open"===this.connection||("linux"!==(0,m.getDevice)().platform&&this._jazzInstance.MidiInOpen(this.name,f.bind(this)),this.connection="open",(0,l.dispatchEvent)(this))}},{key:"close",value:function(){"closed"===this.connection||("linux"!==(0,m.getDevice)().platform&&this._jazzInstance.MidiInClose(),this.connection="closed",(0,l.dispatchEvent)(this),this._onmidimessage=null,this.onstatechange=null,this._listeners.get("midimessage").clear(),this._listeners.get("statechange").clear())}},{key:"_appendToSysexBuffer",value:function(a){var b=this._sysexBuffer.length,c=new Uint8Array(b+a.length);c.set(this._sysexBuffer),c.set(a,b),this._sysexBuffer=c}},{key:"_bufferLongSysex",value:function(a,b){for(var c=b;c<a.length;){if(247==a[c])return c+=1,this._appendToSysexBuffer(a.slice(b,c)),c;c+=1}return this._appendToSysexBuffer(a.slice(b,c)),this._inLongSysexMessage=!0,c}}]),a}();c.default=q,f=function(a,b){var c,d=0,f=!1;for(c=0;c<b.length;c+=d){var g=!0;if(this._inLongSysexMessage){if(c=this._bufferLongSysex(b,c),247!=b[c-1])return;f=!0}else switch(f=!1,240&b[c]){case 0:d=1,g=!1;break;case 128:case 144:case 160:case 176:case 224:d=3;break;case 192:case 208:d=2;break;case 240:switch(b[c]){case 240:if(c=this._bufferLongSysex(b,c),247!=b[c-1])return;f=!0;break;case 241:case 243:d=2;break;case 242:d=3;break;default:d=1;}}if(g){var h={};if(h.receivedTime=parseFloat(a.toString())+this._jazzInstance._perfTimeZero,f||this._inLongSysexMessage?(h.data=new Uint8Array(this._sysexBuffer),this._sysexBuffer=new Uint8Array(0),this._inLongSysexMessage=!1):h.data=new Uint8Array(b.slice(c,d+c)),p)this._onmidimessage&&this._onmidimessage(h);else{var j=new i.default(this,h.data,h.receivedTime);this.dispatchEvent(j)}}}}},{"../util/store":9,"../util/util":10,"./midi_access":3,"./midiconnection_event":6,"./midimessage_event":7}],5:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(c,"__esModule",{value:!0});var e=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),f=a("../util/util"),g=a("../util/store"),h=function(a){return a&&a.__esModule?a:{default:a}}(g),i=a("./midi_access"),j=function(){function a(b,c){d(this,a),this.id=(0,i.getMIDIDeviceId)(b[0],"output"),this.name=b[0],this.manufacturer=b[1],this.version=b[2],this.type="output",this.state="connected",this.connection="pending",this.onmidimessage=null,this.onstatechange=null,this._listeners=new h.default,this._inLongSysexMessage=!1,this._sysexBuffer=new Uint8Array,this._jazzInstance=c,this._jazzInstance.outputInUse=!0,"linux"===(0,f.getDevice)().platform&&this._jazzInstance.MidiOutOpen(this.name)}return e(a,[{key:"open",value:function(){"open"===this.connection||("linux"!==(0,f.getDevice)().platform&&this._jazzInstance.MidiOutOpen(this.name),this.connection="open",(0,i.dispatchEvent)(this))}},{key:"close",value:function(){"closed"===this.connection||("linux"!==(0,f.getDevice)().platform&&this._jazzInstance.MidiOutClose(),this.connection="closed",(0,i.dispatchEvent)(this),this.onstatechange=null,this._listeners.clear())}},{key:"1",value:function(a,b){var c=this,d=0;return 0!==a.length&&(b&&(d=Math.floor(b-performance.now())),b&&1<d?setTimeout(function(){c._jazzInstance.MidiOutLong(a)},d):this._jazzInstance.MidiOutLong(a),!0)}},{key:"clear",value:function(){}},{key:"addEventListener",value:function(a,b){"statechange"!==a||!1===this._listeners.has(b)&&this._listeners.add(b)}},{key:"removeEventListener",value:function(a,b){"statechange"!==a||!0===this._listeners.has(b)&&this._listeners.delete(b)}},{key:"dispatchEvent",value:function(a){this._listeners.forEach(function(b){b(a)}),null!==this.onstatechange&&this.onstatechange(a)}}]),a}();c.default=j},{"../util/store":9,"../util/util":10,"./midi_access":3}],6:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(c,"__esModule",{value:!0});c.default=function a(b,c){d(this,a),this.bubbles=!1,this.cancelBubble=!1,this.cancelable=!1,this.currentTarget=b,this.defaultPrevented=!1,this.eventPhase=0,this.path=[],this.port=c,this.returnValue=!0,this.srcElement=b,this.target=b,this.timeStamp=Date.now(),this.type="statechange"}},{}],7:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(c,"__esModule",{value:!0});c.default=function a(b,c,e){d(this,a),this.bubbles=!1,this.cancelBubble=!1,this.cancelable=!1,this.currentTarget=b,this.data=c,this.defaultPrevented=!1,this.eventPhase=0,this.path=[],this.receivedTime=e,this.returnValue=!0,this.srcElement=b,this.target=b,this.timeStamp=Date.now(),this.type="midimessage"}},{}],8:[function(a,b,c){"use strict";function d(b){var c="jazz_"+i+"_"+Date.now();i+=1;var d,e;if(!0===(0,g.getDevice)().nodejs)d=new navigator.jazzMidi.MIDI;else{e=document.createElement("object"),e.id=c+"ie",e.classid="CLSID:1ACE1618-1C7D-4561-AEE1-34842AA85E90",d=document.createElement("object"),d.id=c,d.type="audio/x-jazz",e.appendChild(d);var f=document.createElement("p");f.appendChild(document.createTextNode("This page requires the "));var k=document.createElement("a");k.appendChild(document.createTextNode("Jazz plugin")),k.href="http://jazz-soft.net/",f.appendChild(k),f.appendChild(document.createTextNode(".")),d.appendChild(f);var a=document.getElementById("MIDIPlugin");a||(a=document.createElement("div"),a.id="MIDIPlugin",a.style.position="absolute",a.style.visibility="hidden",a.style.left="-9999px",a.style.top="-9999px",document.body.appendChild(a)),a.appendChild(e)}setTimeout(function(){var a=null;!0===d.isJazz?a=d:!0===e.isJazz&&(a=e),null!==a&&(a._perfTimeZero=performance.now(),j.set(i,a)),b(a)},h)}Object.defineProperty(c,"__esModule",{value:!0}),c.createJazzInstance=d,c.getJazzInstance=function(a,b){for(var c,e="input"===a?"inputInUse":"outputInUse",f=null,g=j.values(),h=0;h<g.length;h+=1)if(c=g[h],!0!==c[e]){f=c;break}null===f?d(b):b(f)};var e=a("./store"),f=function(a){return a&&a.__esModule?a:{default:a}}(e),g=a("./util"),h="firefox"===(0,g.getDevice)().browser?200:100,i=0,j=new f.default},{"./store":9,"./util":10}],9:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(c,"__esModule",{value:!0});var e=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),f=0,g=function(){function a(){d(this,a),this.store={},this.keys=[]}return e(a,[{key:"add",value:function(a){var b=""+new Date().getTime()+f;f+=1,this.keys.push(b),this.store[b]=a}},{key:"set",value:function(a,b){return this.keys.push(a),this.store[a]=b,this}},{key:"get",value:function(a){return this.store[a]}},{key:"has",value:function(a){return-1!==this.keys.indexOf(a)}},{key:"delete",value:function(a){delete this.store[a];var b=this.keys.indexOf(a);return-1<b&&this.keys.splice(b,1),this}},{key:"values",value:function(){for(var a,b=[],c=this.keys.length,d=0;d<c;d+=1)a=this.store[this.keys[d]],b.push(a);return b}},{key:"forEach",value:function(a){for(var b,c=this.keys.length,d=0;d<c;d+=1)b=this.store[this.keys[d]],a(b)}},{key:"clear",value:function(){this.keys=[],this.store={}}}]),a}();c.default=g},{}],10:[function(a,b,c){(function(a,b){"use strict";function d(){return"undefined"==typeof f?(f=null,"undefined"==typeof window?"undefined"!=typeof b&&(f=b):f=window,f):f}function e(){var b=d();if(null!=g)return g;var c="undetected",e="undetected";if(!0===b.navigator.node)return g={platform:a.platform,nodejs:!0,mobile:"ios"==c||"android"==c},g;var f=b.navigator.userAgent;return f.match(/(iPad|iPhone|iPod)/g)?c="ios":-1===f.indexOf("Android")?-1===f.indexOf("Linux")?-1===f.indexOf("Macintosh")?-1!==f.indexOf("Windows")&&(c="windows"):c="osx":c="linux":c="android",-1===f.indexOf("Chrome")?-1===f.indexOf("Safari")?-1===f.indexOf("Firefox")?-1!==f.indexOf("Trident")&&(e="ie",-1!==f.indexOf("MSIE 9")&&(e="ie9")):e="firefox":e="safari":(e="chrome",-1===f.indexOf("OPR")?-1!==f.indexOf("Chromium")&&(e="chromium"):e="opera"),"ios"==c&&-1!==f.indexOf("CriOS")&&(e="chrome"),g={platform:c,browser:e,mobile:"ios"==c||"android"==c,nodejs:!1},g}Object.defineProperty(c,"__esModule",{value:!0}),c.getScope=d,c.getDevice=e,c.generateUUID=function(){var a=new Date().getTime(),b=Array(64).join("x");return b=b.replace(/[xy]/g,function(b){var c=0|(a+16*Math.random())%16;return a=Math.floor(a/16),("x"===b?c:8|3&c).toString(16).toUpperCase()}),b},c.polyfill=function(){var a=e();("ie"===a.browser||!0===a.nodejs)&&i(),h()};var f=void 0,g=null,h=function(){var a=d();if("undefined"==typeof a.performance&&(a.performance={}),Date.now=Date.now||function(){return new Date().getTime()},"undefined"==typeof a.performance.now){var b=Date.now();"undefined"!=typeof a.performance.timing&&"undefined"!=typeof a.performance.timing.navigationStart&&(b=a.performance.timing.navigationStart),a.performance.now=function(){return Date.now()-b}}},i=function(){var a=d();"function"!=typeof a.Promise&&(a.Promise=function(a){this.executor=a},a.Promise.prototype.then=function(a,b){"function"!=typeof a&&(a=function(){}),"function"!=typeof b&&(b=function(){}),this.executor(a,b)})}}).call(this,a("_process"),"undefined"==typeof global?"undefined"==typeof self?"undefined"==typeof window?{}:window:self:global)},{_process:1}]},{},[2]);

// Speech recognition engine
var final_transcript = '';
var recognizing = false;
var ignore_onend;
var recognition = new webkitSpeechRecognition();
recognition.continuous = true;
recognition.interimResults = false;
recognition.lang = 'en-GB';

// Callback for starting speech recognition
recognition.onstart = function() {
  recognizing = true;
  console.log('Speech recognition running...');
  document.getElementById("input_textbox").style.backgroundColor = '#220000';
};

// Callback for end of speech recognition
recognition.onend = function() {
  recognizing = false;
  console.log('Speech recognition stopped...');
  document.getElementById("input_textbox").style.backgroundColor = '#000000';
};

// Callback for speech recognition error
recognition.onerror = function(event) {
  if (event.error == 'no-speech') {
    console.log('No speech');
    ignore_onend = true;
  }
  if (event.error == 'audio-capture') {
    console.log('No microphone');
    ignore_onend = true;
  }
  if (event.error == 'not-allowed') {
    console.log('Denied');
    ignore_onend = true;
  }
};

// Callback for speech recognition results
recognition.onresult = function(event) {
  // Assemble the speech
  for (var i = event.resultIndex; i < event.results.length; ++i) {
    if (event.results[i].isFinal) {
      final_transcript += event.results[i][0].transcript;
    }
  }
  console.log(final_transcript);
  query = final_transcript;
  document.getElementById("input_textbox").value = '';
  sendQuery(query, user_human);
  final_transcript = '';
};

// Callback for starting speech recognition
function startSpeech() {
  if (recognizing) {
    recognition.stop();
    return;
  }
  final_transcript = '';
  recognition.start();
  ignore_onend = false;
}


// Music features
var play_music = false;
var music_arousal = 0;
var music_valence = 0;
var music_complexity = 0;
var music_choice = -1;
var music_prev_choice = -1;


// Function called at initialisation when loading the page
window.onload = function () {
  console.log("midi_control onload");
  var midiAccess;  // Variable storing the MIDI object
  var activeInputs = {};


  // Request MIDI access from the page
  if (navigator.requestMIDIAccess !== undefined) {
    navigator.requestMIDIAccess().then(

      // Callback function for when the request succeeds
      function onFulfilled(access) {
        midiAccess = access;

        // Update the device list when devices get connected, disconnected, opened or closed
        midiAccess.onstatechange = function (e) {
          var port = e.port;
          var activePorts = activeInputs;

          if (port.state === 'disconnected') {
            // Device disconnected
            port.close();
            console.log('Connected port: type: ' + port.type + ', id: ' + port.id)
            console.log(port.name + ' (' + port.state + ', ' + port.connection + ')')
            delete activePorts[port.type + port.id];

          } else {
            // New device connected: add a listener to the port
            console.log('Connected port: type: ' + port.type + ', id: ' + port.id)
            console.log(port.name + ' (' + port.state + ', ' + port.connection + ')')
            port.onmidimessage = inputListener;
            activePorts[port.type + port.id] = port;
          }
        };
      },

      function onRejected(e) {
        console.log(e.message);
      }
    );
  } else {
    // Browsers without WebMIDI API or Jazz plugin
    console.log('No access to MIDI devices: browser does not support WebMIDI API');
  }


  // Function that handles incoming MIDI messages
  function inputListener(midimessageEvent) {
    var data = midimessageEvent.data;
    var type = data[0];
    var data1 = data[1];
    var data2 = data[2];

    // do something graphical with the incoming midi data
    console.log("MIDI " + type + ' ' + data1 + ' ' + data2);
    // Button press events:
    //   type = 154 button press
    //   type = 144 button release
    //   data2 is the pressure intensity, from 0 to 127
    // Button IDs:
    //   data1 = 36, 37, 38, 39 bottom row (PAD 1 through PAD 4)
    //   data1 = 40, 41, 42, 43 top row (PAD 5 through PAD 8)
    // Potentiometer events:
    //   type = 176
    //   data1 = 1 K1
    //   data1 = 2 K2
    //   data1 = 3 K3
    //   data1 = 4 K4
    //   data1 = 5 K5
    //   data1 = 6 K6
    //   data1 = 7 K7
    //   data1 = 8 K8
    //   data2 is the value, going from 0 (left) to 127 (right)

    // Trigger the speech recognition event on/off
    if ((type === 154) && (data1 === 36) && (data2 > 0)) {
      startSpeech();
    }

    // Select response from 1 to 4
    if ((type === 154) && (data1 === 40) && (data2 > 0)) {
      textToSpeech(1);
    }
    if ((type === 154) && (data1 === 41) && (data2 > 0)) {
      textToSpeech(2);
    }
    if ((type === 154) && (data1 === 42) && (data2 > 0)) {
      textToSpeech(3);
    }
    if ((type === 154) && (data1 === 43) && (data2 > 0)) {
      textToSpeech(4);
    }

    // Reset the neural network and change voice
    if ((type === 154) && (data1 === 37) && (data2 > 0)) {
      resetNetwork();
    }

    // Reset the neural network and change voice
    if ((type === 154) && (data1 === 38) && (data2 > 0)) {
      if (music_choice !== music_prev_choice) {
        music(music_choice);
        music_prev_choice = music_choice;
      }
    }

    // Stop or restart the music
    if ((type === 176) && (data1 === 1) && (data2 == 0)) {
      play_music = false;
      processMusic();
    }
    if ((type === 176) && (data1 === 1) && (data2 > 0)) {
      play_music = true;
      processMusic();
    }

    // Change the music quality
    if ((type === 176) && (data1 === 2)) {
      music_arousal = data2;
      processMusic();
    }
    if ((type === 176) && (data1 === 3)) {
      music_valence = data2;
      processMusic();
    }
    if ((type === 176) && (data1 === 4)) {
      music_complexity = data2;
      processMusic();
    }
  }
};


// URL and port of the A.L.Ex server
var address_port = "162.246.157.131:8888"

// Change the address and port of the server
function changeAddressPort() {
  address_port = document.getElementById("server_address_port").value;
  address_port = address_port.trim();
  console.log("Set the address and port to " + address_port);
  document.getElementById("input_server_address_port").value = address_port;
  startTimerMaster();
}

var conversation_id = Date.now();
// Query and reply timeouts
var query = '';
var reply = '';

var timeout_input = null;
var timeout_reply = null;
var timeout_master = null;
var wait_duration_input = 5000;
var wait_duration_reply = 100;
var wait_duration_master = 500;

// Users
var user_control = "control";
var user_human = "human";
var user_music = "music";
var user_master = "Master";

// Speech API
var synth = window.speechSynthesis;
var banned_voices = ["Agnes", "Alex", "Allison", "Albert", "Bad News", "Bahh",
                     "Bells", "Boing", "Bruce", "Bubbles", "Cellos", "Deranged",
                     "Fiona", "Fred", "Good News", "Kathy", "Hysterical",
                     "Junior", "Pipe Organ", "Princess", "Ralph", "Tessa",
                     "Trinoids", "Veena", "Vicki", "Victoria", "Whisper",
                     "Zarvox"];
var voices = [];
var voice_idx = 0;
var num_voices = 0;
var speech_rate = 0.8;
var speech_vol= 0;
var tempReplies = [];
var logRows = [];

// Function to populate the voice list
function changeVoice() {
  if (num_voices == 0) {
    var voice_candidates = synth.getVoices();
    console.log(voice_candidates);
    var selector_voices = document.getElementById("voices_list");
    for (i = 0; i < voice_candidates.length ; i++) {
      if (voice_candidates[i].lang.startsWith("en")) {
        var name = voice_candidates[i].name;
        if (banned_voices.indexOf(name) == -1) {
          selector_voices.options[selector_voices.options.length] = new Option(name, name);
          voices[num_voices] = voice_candidates[i];
          console.log(num_voices + ': ' + name + ' (' + voice_candidates[i].lang + ')');
          num_voices += 1;
        }
      }
    }
  }
  voice_name = document.getElementById("voices_list").value;
  voice_name = voice_name.trim();
  for (i = 0; i < num_voices; i++) {
    if (voices[i].name == voice_name) {
      voice_idx = i;
      console.log("Set the voice to " + voice_name + ": " + voice_idx);
    }
  }
}
changeVoice();
if (speechSynthesis.onvoiceschanged !== undefined) {
  speechSynthesis.onvoiceschanged = changeVoice;
}

// Function to change the speech rate
function changeSpeechRate() {
  speech_rate = document.getElementById("speech_rate").value / 100.0;
  speech_vol =  document.getElementById("speech_rate").value * 1 ;
}


// Function to reset the network
function resetNetwork() {
  console.log('resetNetwork')
  query_span.innerText = '';
  previous_span.innerText = '';
  reply01_button.value = '';
  reply02_button.value = '';
  reply03_button.value = '';
  reply04_button.value = '';
  selectRandomVoice();
  conversation_id = Date.now();
  sendQuery("reset", user_control);
}


// Extract the text from a button or from the past query
function getText(idx) {
  var text = '';
  if (idx == 0) { text = query_span.innerText; }
  if (idx == 1) { text = reply01_button.value; }
  if (idx == 2) { text = reply02_button.value; }
  if (idx == 3) { text = reply03_button.value; }
  if (idx == 4) { text = reply04_button.value; }
  return text;
}


// Callback for manual interruption of speech recognition
function overwriteInput(idx) {
  if ((idx >= 0) && (idx <= 5)) {
    query = getText(idx);
    textToSpeech(idx);
    sendQuery(query, user_human);
  }
};


// Callback for manual entry of text
function inputText() {
  if (timeout_input !== null) {
    clearTimeout(timeout_input);
  }
  timeout_input = setTimeout(function () {
    console.log("inputText after timeout");
    query = document.getElementById("input_textbox").value;
    if (query.length > 0) {
      document.getElementById("input_textbox").value = '';
      sendQuery(query, user_human);
    }
  }, wait_duration_input);
};
document.getElementById("input_textbox").addEventListener("keyup", function(event) {
  event.preventDefault();
  if (event.keyCode === 13) {
    console.log("Enter");
    query = document.getElementById("input_textbox").value;
    if (query.length > 0) {
      document.getElementById("input_textbox").value = '';
      sendQuery(query, user_human);
    }
  }
});

// Callback for music selection
function music(idx) {
  sendQuery("" + idx, user_music);
  console.log("music " + idx);
};


// Processing of music choice
function processMusic() {
  if (play_music == true) {
    valen = music_valence;
    arouse = music_arousal;
    // Play music
    // Dark 0 01
    if ((valen < 32) && (music_arousal < 64)) {
      music_choice = 2;
    }
    // Scary 0 23
    if ((valen < 32) && (music_arousal >= 64)) {
      music_choice = 3;
    }
    // Mysterious 1 2
    if ((valen >= 32) && (valen < 64) && (arouse >= 64) && (arouse < 96)) {
      music_choice = 4;
    }
    // Intense 1 3
    if ((valen >= 32) && (valen < 64) && (arouse >= 96)) {
      music_choice = 5;
    }
    // Blues 1 1
    if ((valen >= 32) && (valen < 64) && (arouse >= 32) && (arouse < 64)) {
      music_choice = 6;
    }
    // Sad 1 0
    if ((valen >= 32) && (valen < 64) && (arouse < 32)) {
      music_choice = 7;
    }
    // Love 2 23
    if ((valen >= 64) && (valen < 96) && (arouse >= 64)) {
      music_choice = 8;
    }
    // Hope 2 01
    if ((valen >= 64) && (valen < 96) && (arouse < 64)) {
      music_choice = 9;
    }
    // Optimistic 3 1
    if ((valen >= 96) && (arouse >= 32) && (arouse < 64)) {
      music_choice = 9;
    }
    // Wistful 3 0
    if ((valen >= 96) && (arouse < 32)) {
      music_choice = 9;
    }
    // Happy 3 2
    if ((valen >= 96) && (arouse >= 64) && (arouse < 96)) {
      music_choice = 9;
    }
    // Quirky 3 3
    if ((valen >= 96) && (arouse >= 96)) {
      music_choice = 9;
    }
  } else {
    // Stop the music
    music_choice = -1;
  }
  console.log("Choose music " + music_choice);
}


// Clean the line from escape character sequences
function unescape(line) {
  // console.log("Before " + line);
  line = line.replace(/_ESCAPEDSPACE_/g, " ");
  line = line.replace(/_ESCAPEDDASH/g, "-");
  line = line.replace(/_ESCAPEDDOUBLEQUOTE/g, "\"");
  line = line.replace(/_ESCAPEDQUOTE/g, "'");
  line = line.replace(/_ESCAPEDPLUS/g, "+");
  line = line.replace(/_ESCAPEDCOLON/g, ":");
  line = line.replace(/_ESCAPEDSEMICOLON/g, ";");
  line = line.replace(/_ESCAPEDAMPERSAND/g, "&");
  line = line.replace(/_ESCAPEDQUESTION/g, "?");
  line = line.replace(/_ESCAPEDEXCLAMATION/g, "!");
  line = line.replace(/_ESCAPEDPERCENT/g, "%");
  line = line.replace(/_ESCAPEDAROBASE/g, "@");
  line = line.replace(/_ESCAPEDSLASH/g, "/");
  line = line.replace(/_ESCAPEDBACKSLASH/g, "\\");
  line = line.replace(/_ESCAPEDNEWLINE/g, "<br> ");
  line = line.replace(/\r\n\r\n$/, "");
  line = line.replace(/^\'/, "");
  line = line.replace(/\'$/, "");
  // console.log("After " + line);
  return line;
}


// Remove after <BR>
function removeAfterBR(line) {
  var idx = line.indexOf("<br>");
  line = line.substring(0, idx);
  return line;
}


// Populate the multiple choice response buttons
function populateAnswers(reply) {
  if (reply.indexOf("{1} ") == -1) {
    reply01_button.value = reply;
  } else {
    var value01 = reply.replace(/\{1\} /, "")
    value01 = removeAfterBR(value01);
    // reply01_button.value = value01;
    modelResponses.push(value01);
    tempReplies.push(value01);
    tempReplies.push('alex');
    var value02 = reply.replace(/.*\{2\} /, "");
    value02 = removeAfterBR(value02);
    // reply02_button.value = value02;
    modelResponses.push(value02);
    tempReplies.push(value02);
    tempReplies.push('alex');
    // var value03 = reply.replace(/.*\{3\} /, "");
    // value03 = removeAfterBR(value03);
    // reply03_button.value = value03;
    // var value04 = reply.replace(/.*\{4\} /, "");
    // value04 = removeAfterBR(value04);
    // reply04_button.value = value04;
  }
}


// Play the sound of a reply
function textToSpeech(idx) {
  // Focus on the input
  document.getElementById('input_textbox').focus();

  // There is no need to pronounce what is in box 0 (not generated by AI).
  if (idx == 0) {
    return;
  }

  var text = getText(idx);
  previous_span.innerText = text;
  console.log("textToSpeech(" + idx + "): " + text);

  // Pause speech recognition
  var restart_speech_after_tts = false;
  if (recognizing == true) {
    startSpeech();
    restart_speech_after_tts = true;
  }

  // Say the sentence
  var speech = new SpeechSynthesisUtterance(text);
  speech.voice = voices[voice_idx];
  speech.pitch = 1.0;
  speech.rate = speech_rate;
  speech.volume = speech_vol;
  synth.speak(speech);
  // send to robot ALAnimatedSpeech
//   RobotUtils.onService(function(ALTextToSpeech) {
  RobotUtils.onService(function(ALAnimatedSpeech) {
        // Bind button callbacks
        ALAnimatedSpeech.say(text);

    });
  
  sendQuery(text, "control")
  previous_span.innerText = text;
  // Restart speech once the sentence is said
  if (restart_speech_after_tts == true) {
    speech.onend = function() {
      startSpeech();
    }
  }
  // New line for log:
  logRows.push(conversation_id+',"'+tempReplies.join('","')+'","'+text+'"');
  // tempReplies.length = 1;
}
function saveLog(){
  filename = Date.now()+'_Improbotics_JannALEx.csv';
  var file = new Blob([logRows.join('\n')], {type: "text/plain;charset=utf-8"});
  var a = document.createElement("a"),
                url = URL.createObjectURL(file);
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(function() {
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);  
        }, 0); 
logRows.length = 0;
}

// Callback for sending a query
function waitReply() {

  // Callback to display reply from server
  var xmlHttp = new XMLHttpRequest();
  xmlHttp.onreadystatechange = function() {
      if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
        reply = xmlHttp.responseText;
        reply = unescape(reply);
        console.log("Server reply: [" + reply + "]");
        if (reply.length > 0) {
          // If we have new results, update dialog box
          populateAnswers(reply);
        } else {
          startTimerReply();
        }
      }
  }
  // Send the transcript lines to server and wait for reply
  var url = "http://" + address_port + "/?USERARGKEY=ai";
  console.log("Sending URL: " + url);
  xmlHttp.open("GET", url, true);
  xmlHttp.send(null);
};


// Start the timer to wait for a reply
function startTimerReply() {
  if (timeout_reply !== null) {
    clearTimeout(timeout_reply);
  }
  timeout_reply = setTimeout(function () {
    waitReply();
  }, wait_duration_reply);
}


// Callback for waiting for Master updates
function waitMaster() {

  // Callback to display reply from server
  var xmlHttp = new XMLHttpRequest();
  xmlHttp.onreadystatechange = function() {
      if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
        line = xmlHttp.responseText;
        line = unescape(line);
        console.log("Server Master line: [" + line + "]");
        if (line.length > 0) {
          // If we have new results, update dialog box
          query_span.innerText = line;
        }
        startTimerMaster();
      }
  }
  // Send the transcript lines to server and wait for reply
  var url = "http://" + address_port + "/?USERARGKEY=" + user_master;
  console.log("Sending URL: " + url);
  xmlHttp.open("GET", url, true);
  xmlHttp.send(null);
};


// Start the timer to wait for the Master inputs
function startTimerMaster() {
  if (timeout_master !== null) {
    clearTimeout(timeout_master);
  }
  timeout_master = setTimeout(function () {
    waitMaster();
  }, wait_duration_master);
}
startTimerMaster();

// Globals are always a good idea right?
let modelResponses = new Array;

// Callback for sending a query
function sendQuery(query, user) {

  // Display the query
  //query = capitalize(query);
  query_span.innerText = query;

  // Callback to trigger a timer to query the server
  var xmlHttp = new XMLHttpRequest();
  xmlHttp.onreadystatechange = function() {
      if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
        if (user == user_human) {
          startTimerReply();
        }
        console.log("sendQuery: user: " + user + ", query: " + query);
      }
  }
  // Send the transcript lines to the ALEx server
  var url = "http://" + address_port + "/?USERARGKEY=" + user +
            "&LINEARGKEY='" + query + "'";
  console.log("Sending URL: " + url);
  xmlHttp.open("GET", url, true);
  xmlHttp.send(null);
  // Don't care about non-human queries
  if (user == "human"){
    tempReplies.length = 0;
    tempReplies.push(query)
  // Send transcript to JANN
  // Jann endpoints - need to proxy through cors-anywhere to not cause cors error in fetch (fix this at some point):
  var proxyUrl = 'https://cors-anywhere.herokuapp.com/',
    targetUrl = encodeURI('https://korymath.ngrok.io/model_inference?msg='+query);

// Not sure if we want to seed the query differently for each request, to improve odds of unique responses
let urls = [
encodeURI('https://korymath.ngrok.io/model_inference?msg='+query),
encodeURI('https://korymath.ngrok.io/model_inference?msg='+query),
];
var jannResult = [];
var reqList = [];

// Store fetch promises and results
urls.forEach(function(url,i){
  reqList.push(
    fetch(proxyUrl+url).then(function(res){
      jannResult[i] = res.blob();
    })
  )
})

// When resutls are recieved, parse and store in modelResponse array
Promise.all(reqList).then(function(){
  jannResult.forEach(function(res){
    res.then(function(response){
      var reader = new FileReader();
reader.onload = function() {
    jannReply = reader.result.replace(/"/g,"")
    modelResponses.push(jannReply);
    tempReplies.push(jannReply);
    tempReplies.push('jann');
}
      reader.readAsText(response);
    })
  })
})
}

};
// Callback for monitoring the response array
var eventify = function(arr, callback) {
    arr.push = function(e) {
        Array.prototype.push.call(arr, e);
        callback(arr);
    };
};
// When 4 results are populated into the response array, set as options for responses and clear array
// TODO: Add logging.
eventify(modelResponses, function(newArray) {
  if (newArray.length == 4){
    shuffleArray(newArray);
    console.log('Responses:')
    console.log(newArray[0])
    reply01_button.value = newArray[0];
    console.log(newArray[1])
    reply02_button.value = newArray[1];
    console.log(newArray[2])
    reply03_button.value = newArray[2];
    console.log(newArray[3])
    reply04_button.value = newArray[3];

    modelResponses.length = 0;
  }
  
});

function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }

}

window.onbeforeunload = function() {
   if (logRows.length != 0) {
//if we return nothing here (just calling return;) then there will be no pop-up question at all
   //return;
   return "You have unsaved log files, are you sure you want to leave?";
   }
  
   
};
</script>


</body></html>